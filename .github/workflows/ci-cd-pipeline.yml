name: Deploy and Test API
# Install dependencies, run tests, if tests ok deploy on EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python 3.12.7
        uses: actions/setup-python@v2
        with:
          python-version: '3.12.7'

      - name: Install Dependencies for Tests
        run: |
          python -m venv venv_tests
          source venv_tests/bin/activate
          pip install --upgrade pip
          pip install -r tests/requirements_tests.txt

      - name: Run API Tests
        run: |
          source venv_tests/bin/activate
          pytest tests/test_api.py --maxfail=1 --disable-warnings -v

      - name: Set up SSH for EC2 connection
        if: success()  # Continue only if tests pass
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        if: success()  # Continue only if SSH setup succeeds
        run: |
            ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_API_HOST }} << 'EOF'
            
            # Go to the application directory
            cd ~/streamlit_dashboard_api
            
            # Configure sparse checkout to import only necessary files
            git config core.sparseCheckout true
            echo "api/" > .git/info/sparse-checkout
            echo "models/" >> .git/info/sparse-checkout
            echo "data/processed/" >> .git/info/sparse-checkout
            echo "requirements_api.txt" >> .git/info/sparse-checkout
            git read-tree -mu HEAD
            
            # Pull updates from the repository
            git pull origin main

            # Go to the API directory
            cd api

            # Activate the existing virtual environment (the service uses venv_api)
            source ~/venv_api/bin/activate
            
            # Install necessary dependencies
            pip install --upgrade pip
            pip install -r requirements_api.txt

            # Restart the FastAPI service systemd for the API
            sudo systemctl restart fastapi_api.service

            # Restart Nginx to apply the changes
            sudo systemctl restart nginx
            EOF

      - name: Wait for API to start
        run: sleep 10  # Waits for 10 seconds before running the next step

      - name: Run API Tests (Post Deployment)
        env:
          API_URL: ${{ secrets.API_URL }}  
        run: |
          # Run API tests after deployment
          pytest tests/test_api.py --maxfail=1 --disable-warnings -v

